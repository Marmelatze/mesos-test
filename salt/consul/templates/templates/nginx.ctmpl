{{range ls "proxy"}}
{{with $d := .Value | parseJSON}}
upstream backend-{{$d.service}}-{{$d.servicePort}} {
    {{range service (print $d.service ":" $d.containerPort)}}
    server {{.Address}}:{{.Port}};
    {{end}}
}
server {
    listen {{$d.servicePort}};
    location / {
        proxy_read_timeout 10;
        proxy_pass http://backend-{{$d.service}}-{{$d.servicePort}};
    }
}
{{end}}
{{end}}
